---
layout: post
title:  蓝绿发布,滚动发布,灰度发布/金丝雀发布
image: /img/hello_world.jpeg
date:  2017-06-29 15:00:00 +0800  
tags: [k8s]
labels: [k8s, 微服务发布方式]
k8s: true
---

### 概述
- 目前有很多用于部署的技术，有的简单，有的复杂；有的要停机，有的不需要停机即可部署完成。本文的目的就是将目前常用的部署方案做一个总结。


    在项目迭代的过程中，不可避免需要“上线”。上线对应着部署，或者重新部署；
    部署对应着修改；修改则意味着风险。

###  蓝绿发布 

    Blue/Green  Deployment(蓝绿部署)， 0 downtime, 冗余的原理解决问题，风险小。

- 定义:
    - 蓝绿部署是不停老版本，部署新版本，然后进行测试，确认OK，将流量切换到新版本，然后老版本同时也升级到新版本。

- 特点:
    - 蓝绿部署无需停机，并且风险较小。

- 部署过程:
    - 第一步： 部署版本v1的应用（一开始的状态），所有外部请求的流量都打到这个版本上。
    
   ![](http://p6jsga0vv.bkt.clouddn.com/18-11-11/34600034.jpg)

    - 第二步： 部署版本v2的应用，版本2的代码与版本1不同（新功能，Bug修复等）。
    
    - 第三步： 将流量从版本v1 切换到版本v2.
    
    ![](http://p6jsga0vv.bkt.clouddn.com/18-11-11/27982235.jpg)
    
    - 第四步： 如果版本v2测试正常，就删除版本v1正在使用的资源（例如实例）， 从此正式使用v2版本。
    

- 小结
    - 从过程不难发现，`在部署的过程中，我们的应用始终在线`。 并且，新老版本上线的过程中，并没有修改老版本的任何内容，在部署期间，老版本的状态不受影响。这样风险很小，并且，只要老版本的资源不被删除，理论上，我们可以在任何时候回滚到老版本。


- 蓝绿发布注意事项


    当切换到蓝色环境时，需要妥当处理未完成的业务和新的业务。
    如果你的数据库后端无法处理，会是一个比较麻烦的问题。
 

- 1. 可能会出现需要同时处理"微服务架构应用" 和 "传统架构应用"的情况，如果在蓝绿部署中协调不好这两者，还是有可能会导致服务停止。
- 2. 需要提前考虑数据库与应用部署同步迁移/回滚的问题。
- 3. 蓝绿部署需要有基础设施支持，`毕竟部署了2套环境`。。。
- 4. 在非隔离基础架构（VM, Docker等）上执行蓝绿部署，蓝色环境和绿色环境有被摧毁的风险。


### Rolling update (滚动发布)

- 滚动发布定义
    - 一般取出一个或者多个服务器停止服务，执行更新，并重新将其投入使用。周而复始，直到集群中所有的实例都更新成新版本。

- 特点
    - 这种部署方式相对于蓝绿部署，更加节约资源--- 它不需要运行两个集群，两倍的实例数。我们可以部分部署，例如每次只取集群的20%进行升级。这种方式也有很多缺点，例如：
        
        -  `没有一个确定OK的环境`。使用蓝绿部署，我们能够清晰的知道老版本是OK的，而使用滚动发布，我们无法确定。
        -  修改了现有的环境
        -  如果需要回滚，很困难。例如，发布了100个实例，每次每5分钟更新10个实例。 更新到第80个实例时出现问题，回滚是相对痛苦的，漫长的。
        -  如果系统进行动态伸缩，部署期间，我们还需要判断哪个节点使用的是哪个代码。
        -  `新老版本不一致的情况，服务短暂不可用`，如果对上线要求较高的场景，需要考虑做好兼容的问题。

### 灰度发布/金丝雀发布

- 定义
    - 灰度发布时指在黑与白之间，能够平滑过渡的一种方式。 AB test就是一种灰度发布方式，`让一部分用户继续用A, 一部分用户开始用B`, 如果用户对B没有什么意见，那么逐步扩大范围，把所有用户都迁移到B上面。`灰度发布可以保证整体系统得到稳定，在初始灰度的时候就可以发现，调整问题，以保证其影响度，而我们平常所说的金丝雀部署也就是灰度发布的一种方式`。
    

####

    注释: 矿井中的金丝雀，发现瓦斯泄露，以便在危险状况下紧急撤离。


- 灰度发布结构图

![](http://p6jsga0vv.bkt.clouddn.com/18-11-11/55541101.jpg)

- 灰度发布/金丝雀发布的步骤
    - 准备好部署各个阶段的工件, 包括：构建工件，测试脚本，配置文件和部署清单文件。
    
    - 升级金丝雀应用 （应用的修改）
    - 对应用进行自动化测试
    - 在负载均衡器中添加金丝雀服务器
    - 在测试，如果金丝雀在线测试成功，升级剩余其他服务器（否则就回滚）


    除此之外，灰度发布还可以设置路由权重，动态调整不同的权重来进行新老版本的验证。

### A/B 测试的区别

    A/B 测试是一种用于提升App/H5/小程序产品转化率，例如一个页面做两个不同的页面，
    一部分用户用A, 一部分用户用B， 收集点击量等指标判断不同方案的优略，并进行决策。

### 总结

(1) 蓝绿部署：不停止老版本，额外搞一套新版本，等测试发现新版本OK后，删除老版本。

(2) 滚动发布：按批次停止老版本实例，启动新版本实例。

(3) 灰度发布/金丝雀部署：不停止老版本，额外搞一套新版本，常常按照用户设置路由权重，例如90%的用户维持使用老版本，10%的用户尝鲜新版本。不同版本应用共存，经常与A/B测试一起使用，用于测试选择多种方案。

### 参考资料
- [简书博客](https://www.jianshu.com/p/311009781b77)
- [知乎博客](https://www.zhihu.com/question/20045543/answer/120368785)

    
 **Note:** 如果你遇到任何问题，欢迎下面留言哈！ 整理不易，欢迎打赏！
